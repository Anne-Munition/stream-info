FROM node:16.13.2-alpine3.15 as base
RUN apk add --no-cache graphicsmagick
WORKDIR /app

FROM base AS backend_prod_dependencies
COPY ./backend/package.json ./backend/yarn.lock ./
RUN yarn --production=true

FROM backend_prod_dependencies as backend_dev_dependencies
RUN yarn --production=false

FROM backend_dev_dependencies as builder
COPY ./backend .
RUN yarn prettier
RUN yarn lint
RUN yarn test
RUN yarn build

FROM base
COPY --from=backend_prod_dependencies /app/node_modules ./backend/node_modules
COPY --from=builder /app/dist ./backend/dist

# This docker image is merged with the frontend in CI
